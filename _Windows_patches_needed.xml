<?xml version="1.0" encoding="UTF-8" ?>
<feed  version="1.0" hasPendingRequests="false" >
  <company></company>
  <status>200</status>
  <errmsg>OK</errmsg>
  <interval>0</interval>
    <entry type="predatasource">
        <version>1538254585</version>
        <name>_Windows patches needed</name>
        <displayedas>_Windows patches needed</displayedas>
        <description>by Mike Suding. Shows classifications of &#34;Critical Updates&#34;, Definition Updates, Security Updates, Security-only Updates, Updates. You can change this in scripts below.</description>
        <collector>batchscript</collector>
        <hasMultiInstances>true</hasMultiInstances>
        <schedule>3600</schedule>
        <appliesTo>isWindows()</appliesTo>
        <wildcardauto>true</wildcardauto>
        <wildcardpersist>false</wildcardpersist>
        <wildcardlinuxscript>ad_script</wildcardlinuxscript>
        <wildcardlinuxcmdline>type=&#34;powerShell&#34; </wildcardlinuxcmdline>
        <wildcardwinscript>ad_script</wildcardwinscript>
        <wildcardwincmdline>type=&#34;powerShell&#34; </wildcardwincmdline>
        <wildcardgroovyscript>$TargetHostName = &#39;##SYSTEM.SYSNAME##&#39;
$CollectorHostName = $env:computername
$TargetUserName = &#39;##wmi.user##&#39;
$TargetPassword = &#39;##wmi.pass##&#39;
$SearchedUpdateList = @(&#34;Critical Updates&#34;, &#34;Definition Updates&#34;, &#34;Security Updates&#34;, &#34;Security-only Updates&#34;, &#34;Updates&#34;)

$ScriptBlock = {

    param ([String[]]$SearchedUpdateCategory)
    #Output summary object
    Write-Host &#34;Update_Summary##Update Summary&#34;

    Try
    {
        #Start searching updates
        $Searcher = New-Object -ComObject Microsoft.Update.Searcher
        $Updates = $Searcher.Search(&#34;IsHidden=0 and IsInstalled=0&#34;).Updates

        #Counter of unmarked updates, need for ID of instances
        [int]$CounterOfUnmarkedUpdates = 0

        Foreach ($Update in $Updates)
        {
            $UpdateCategory = ($Update.Categories | Where-Object {$_.Type -eq &#34;UpdateClassification&#34;}).Name
            If ($UpdateCategory -in $SearchedUpdateCategory)
            {
                If ($Update.KBArticleIDs.Count)
                {
                    $UpdateKbIndex = $(&#34;KB&#34; + $Update.KBArticleIDs.Item(0))
                }
                Else
                {
                    $UpdateKbIndex = $(&#34;UP&#34; + $CounterOfUnmarkedUpdates.ToString())
                    $CounterOfUnmarkedUpdates++
                }
                #Output - kb index, title, and group
                $UpdateKbTitle = $Update.Title.Replace($UpdateKbIndex,&#34;&#34;).Replace(&#34;  &#34;,&#34; &#34;).Replace(&#34;()&#34;,&#34;&#34;)
                If ($Update.MsrcSeverity)
                {
                    $Result_MsrcSeverity = $Update.MsrcSeverity
                }
                else
                {
                    $Result_MsrcSeverity = &#34;unspecified&#34;
                }
                Write-Host &#34;$UpdateKbIndex##$($UpdateKbIndex): $($UpdateKbTitle)######group=$UpdateCategory&#38;auto.MSRCseverity=$Result_MsrcSeverity&#34;
            }
        }
    }
    Catch
    {
        #In case of error - create new instance with error description
        Write-Host &#34;ERROR##$($_.FullyQualifiedErrorId): $($_.Exception.Message)&#34;
    }
}

if ($TargetHostName -eq $CollectorHostName)
{
    Invoke-Command -ScriptBlock $ScriptBlock -ArgumentList @(,$SearchedUpdateList)
}
else
{
    if ($TargetUserName -Match &#34;wmi.user&#34; -and $TargetPassword -Match &#34;wmi.pass&#34;)
    {
        Invoke-Command -ComputerName $TargetHostName -ScriptBlock $ScriptBlock -ArgumentList @(,$SearchedUpdateList)
    }
    else
    {
        $TargetCredentials = New-Object System.Management.Automation.PSCredential ($TargetUserName, $(ConvertTo-SecureString $TargetPassword -AsPlainText -Force))
        Invoke-Command -ComputerName $TargetHostName -ScriptBlock $ScriptBlock -Credential $TargetCredentials -ArgumentList @(,$SearchedUpdateList)
    }
}
exit 0</wildcardgroovyscript>
        <wildcardschedule>60</wildcardschedule>
        <wildcarddisable>false</wildcarddisable>
        <wildcarddeleteinactive>true</wildcarddeleteinactive>
        <agdmethod>ilp</agdmethod>
        <agdparams>group</agdparams>
        <group></group>
        <tags></tags>
        <technology>Other classifications: Update rollups, Monthly Rollups, Preview of Monthly Rollups, Drivers, Service packs, Feature packs, Tools, Servicing Stack Updates (SSU)</technology>
        <adlist><![CDATA[{"agdmethod":"ilp","method":"ad_script","agdparams":"group","id":0,"filters":[],"params":{"type":"powerShell","groovyscript":"$TargetHostName = '##SYSTEM.SYSNAME##'\r\n$CollectorHostName = $env:computername\r\n$TargetUserName = '##wmi.user##'\r\n$TargetPassword = '##wmi.pass##'\r\n$SearchedUpdateList = @(\"Critical Updates\", \"Definition Updates\", \"Security Updates\", \"Security-only Updates\", \"Updates\")\r\n\r\n$ScriptBlock = {\r\n\r\n    param ([String[]]$SearchedUpdateCategory)\r\n    #Output summary object\r\n    Write-Host \"Update_Summary##Update Summary\"\r\n\r\n    Try\r\n    {\r\n        #Start searching updates\r\n        $Searcher = New-Object -ComObject Microsoft.Update.Searcher\r\n        $Updates = $Searcher.Search(\"IsHidden=0 and IsInstalled=0\").Updates\r\n\r\n        #Counter of unmarked updates, need for ID of instances\r\n        [int]$CounterOfUnmarkedUpdates = 0\r\n\r\n        Foreach ($Update in $Updates)\r\n        {\r\n            $UpdateCategory = ($Update.Categories | Where-Object {$_.Type -eq \"UpdateClassification\"}).Name\r\n            If ($UpdateCategory -in $SearchedUpdateCategory)\r\n            {\r\n                If ($Update.KBArticleIDs.Count)\r\n                {\r\n                    $UpdateKbIndex = $(\"KB\" + $Update.KBArticleIDs.Item(0))\r\n                }\r\n                Else\r\n                {\r\n                    $UpdateKbIndex = $(\"UP\" + $CounterOfUnmarkedUpdates.ToString())\r\n                    $CounterOfUnmarkedUpdates++\r\n                }\r\n                #Output - kb index, title, and group\r\n                $UpdateKbTitle = $Update.Title.Replace($UpdateKbIndex,\"\").Replace(\"  \",\" \").Replace(\"()\",\"\")\r\n                If ($Update.MsrcSeverity)\r\n                {\r\n                    $Result_MsrcSeverity = $Update.MsrcSeverity\r\n                }\r\n                else\r\n                {\r\n                    $Result_MsrcSeverity = \"unspecified\"\r\n                }\r\n                Write-Host \"$UpdateKbIndex##$($UpdateKbIndex): $($UpdateKbTitle)######group=$UpdateCategory&auto.MSRCseverity=$Result_MsrcSeverity\"\r\n            }\r\n        }\r\n    }\r\n    Catch\r\n    {\r\n        #In case of error - create new instance with error description\r\n        Write-Host \"ERROR##$($_.FullyQualifiedErrorId): $($_.Exception.Message)\"\r\n    }\r\n}\r\n\r\nif ($TargetHostName -eq $CollectorHostName)\r\n{\r\n    Invoke-Command -ScriptBlock $ScriptBlock -ArgumentList @(,$SearchedUpdateList)\r\n}\r\nelse\r\n{\r\n    if ($TargetUserName -Match \"wmi.user\" -and $TargetPassword -Match \"wmi.pass\")\r\n    {\r\n        Invoke-Command -ComputerName $TargetHostName -ScriptBlock $ScriptBlock -ArgumentList @(,$SearchedUpdateList)\r\n    }\r\n    else\r\n    {\r\n        $TargetCredentials = New-Object System.Management.Automation.PSCredential ($TargetUserName, $(ConvertTo-SecureString $TargetPassword -AsPlainText -Force))\r\n        Invoke-Command -ComputerName $TargetHostName -ScriptBlock $ScriptBlock -Credential $TargetCredentials -ArgumentList @(,$SearchedUpdateList)\r\n    }\r\n}\r\nexit 0"}}]]></adlist>
        <schemaVersion>2</schemaVersion>
        <dataSourceType>1</dataSourceType>
        <attributes>
        <attribute>
            <name>scripttype</name>
            <value>powerShell</value>
            <comment></comment>
        </attribute>
        <attribute>
            <name>scriptgroovy</name>
            <value>#BatchScript; show results for summary object
#Get info about last instalation of patch
#Calculate days, if updates not installed on system - write 0, if error - write -1

$TargetHostName = &#39;##SYSTEM.SYSNAME##&#39;
$CollectorHostName = $env:computername
$TargetUserName = &#39;##wmi.user##&#39;
$TargetPassword = &#39;##wmi.pass##&#39;
$SearchedUpdateList = @(&#34;Critical Updates&#34;, &#34;Definition Updates&#34;, &#34;Security Updates&#34;, &#34;Security-only Updates&#34;, &#34;Updates&#34;)

$ScriptBlock = {
    #Paameter - category of updates
    param ([String[]]$SearchedUpdateCategory)

    Try
    {
        $LastPatch = Get-WmiObject -ComputerName &#34;localhost&#34; Win32_Quickfixengineering | Select-Object @{Name=&#34;InstalledOn&#34;;Expression={$_.InstalledOn -as [datetime]}} | Sort-Object -Property InstalledOn | Select-Object -Property InstalledOn -Last 1
        if ($LastPatch)
        {
            $DayDiff = $(New-TimeSpan $LastPatch.InstalledOn $(Get-Date)).Days
        }
        else
        {
            $DayDiff = 0
        }
    }
    Catch
    {
        $DayDiff = -1
    }
    Write-Host &#34;Update_Summary.LastPatch=$($DayDiff)&#34;

    #Perform update search, filter according to categories, write counts of updates
    Try
    {
        $Searcher = New-Object -ComObject Microsoft.Update.Searcher
        $Updates = $Searcher.Search(&#34;IsHidden=0 and IsInstalled=0&#34;).Updates
        $FilteredUpdates = $Updates | Where-Object {($_.Categories | Where-Object {$_.Type -eq &#34;UpdateClassification&#34;}).Name -in $SearchedUpdateCategory}
        $DiscoveredUpdates = $FilteredUpdates.Count
    }
    Catch
    {
        #In case of error - out -1 as result
        $DiscoveredUpdates = -1
    }
    Write-Host &#34;Update_Summary.UpdatesCount=$($DiscoveredUpdates)&#34;
}

if ($TargetHostName -eq $CollectorHostName)
{
    Invoke-Command -ScriptBlock $ScriptBlock -ArgumentList @(,$SearchedUpdateList)
}
else
{
    if ($TargetUserName -and $TargetPassword)
    {
        $TargetCredentials = New-Object System.Management.Automation.PSCredential ($TargetUserName, $(ConvertTo-SecureString $TargetPassword -AsPlainText -Force))
        Invoke-Command -ComputerName $TargetHostName -ScriptBlock $ScriptBlock -Credential $TargetCredentials -ArgumentList @(,$SearchedUpdateList)
    }
    else
    {
        Invoke-Command -ComputerName $TargetHostName -ScriptBlock $ScriptBlock -ArgumentList @(,$SearchedUpdateList)
    }
}
exit 0</value>
            <comment></comment>
        </attribute>
        <attribute>
            <name>windowsscript</name>
            <value></value>
            <comment></comment>
        </attribute>
        <attribute>
            <name>linuxscript</name>
            <value></value>
            <comment></comment>
        </attribute>
        <attribute>
            <name>windowscmdline</name>
            <value></value>
            <comment></comment>
        </attribute>
        <attribute>
            <name>linuxcmdline</name>
            <value></value>
            <comment></comment>
        </attribute>
        </attributes>
        <datapoints>
        <datapoint>
            <name>DaysSinceLastPatch</name>
            <dataType>7</dataType>
            <type>2</type>
            <postprocessormethod>namevalue</postprocessormethod>
            <postprocessorparam>##wildvalue##.LastPatch</postprocessorparam>
            <usevalue>output</usevalue>
            <alertexpr></alertexpr>
            <alertmissing>1</alertmissing>
            <alertsubject></alertsubject>
            <alertbody></alertbody>
            <description></description>
            <maxvalue></maxvalue>
            <minvalue></minvalue>
            <userparam1></userparam1>
            <userparam2></userparam2>
            <userparam3></userparam3>
            <iscomposite>false</iscomposite>
            <rpn></rpn>
            <alertTransitionIval>0</alertTransitionIval>
            <alertClearTransitionIval>0</alertClearTransitionIval>
        </datapoint>
        <datapoint>
            <name>UpdatesCount</name>
            <dataType>7</dataType>
            <type>2</type>
            <postprocessormethod>namevalue</postprocessormethod>
            <postprocessorparam>##wildvalue##.UpdatesCount</postprocessorparam>
            <usevalue>output</usevalue>
            <alertexpr></alertexpr>
            <alertmissing>1</alertmissing>
            <alertsubject></alertsubject>
            <alertbody></alertbody>
            <description></description>
            <maxvalue></maxvalue>
            <minvalue></minvalue>
            <userparam1></userparam1>
            <userparam2></userparam2>
            <userparam3></userparam3>
            <iscomposite>false</iscomposite>
            <rpn></rpn>
            <alertTransitionIval>0</alertTransitionIval>
            <alertClearTransitionIval>0</alertClearTransitionIval>
        </datapoint>
        <datapoint>
            <name>milliseconds_it_took</name>
            <dataType>4</dataType>
            <type>2</type>
            <postprocessormethod>none</postprocessormethod>
            <postprocessorparam></postprocessorparam>
            <usevalue>responseTime</usevalue>
            <alertexpr></alertexpr>
            <alertmissing>1</alertmissing>
            <alertsubject></alertsubject>
            <alertbody></alertbody>
            <description></description>
            <maxvalue></maxvalue>
            <minvalue></minvalue>
            <userparam1></userparam1>
            <userparam2></userparam2>
            <userparam3></userparam3>
            <iscomposite>false</iscomposite>
            <rpn></rpn>
            <alertTransitionIval>0</alertTransitionIval>
            <alertClearTransitionIval>0</alertClearTransitionIval>
        </datapoint>
        </datapoints>
        <graphs>
        </graphs>
        <overviewgraphs>
        </overviewgraphs>
        <scripts>
        </scripts>
    </entry>
</feed>
